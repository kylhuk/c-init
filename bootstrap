#!/bin/bash
set -e

echo "=== Starting bootstrap process ==="

# Update packages and install basic tools.
apt-get update && apt-get install -y git curl ufw

# Install Pulumi if it's not already installed.
if ! command -v pulumi &>/dev/null; then
  echo "Installing Pulumi..."
  curl -fsSL https://get.pulumi.com | sh
  export PATH=$PATH:$HOME/.pulumi/bin
fi

# Clone the public repository containing the Pulumi program.
REPO_URL="git@github.com:kylhuk/c-init.git"  # Your provided Git repo URL.
WORKDIR="/opt/pulumi-bootstrap"
rm -rf "$WORKDIR"
echo "Cloning repository from $REPO_URL..."
git clone "$REPO_URL" "$WORKDIR"
cd "$WORKDIR"

# Log in to Pulumi using the local file backend.
echo "Logging into Pulumi..."
pulumi login file://~/.pulumi

# Initialize (or use an existing) Pulumi stack.
echo "Initializing stack 'dev'..."
pulumi stack init dev || echo "Stack 'dev' already exists."

# Deploy the infrastructure with Pulumi.
echo "Deploying infrastructure with Pulumi..."
pulumi up --yes --stack dev

echo "=== Bootstrap process complete ==="
